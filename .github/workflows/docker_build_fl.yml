# # Copyright (c) Guy's and St Thomas' NHS Foundation Trust & King's College London
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Build and Push FL Docker Images

on:
  push:
    branches: [main, develop]
    paths:
      - "fl_services/**"
      - ".github/workflows/docker_build_fl.yml"
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      REGISTRY: ghcr.io
      ORG: londonaicentre
      BASE_IMAGE: flare-fl-base
      SERVER_IMAGE: flare-fl-server
      CLIENT_IMAGE: flare-fl-client
      API_IMAGE: flare-fl-api
      BUILD_ARGS: |
        --build-arg UID=1000
        --build-arg GID=1000
        --build-arg UNAME=flip
        --build-arg LOCAL_DEV=false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.workflow_run.head_repository.full_name }}
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Determine image tags
        id: tags
        run: |
          BASE_TAGS="${REGISTRY}/${ORG}/${BASE_IMAGE}:${{ github.sha }}"
          SERVER_TAGS="${REGISTRY}/${ORG}/${SERVER_IMAGE}:${{ github.sha }}"
          CLIENT_TAGS="${REGISTRY}/${ORG}/${CLIENT_IMAGE}:${{ github.sha }}"
          API_TAGS="${REGISTRY}/${ORG}/${API_IMAGE}:${{ github.sha }}"

          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            BASE_TAGS="${BASE_TAGS},${REGISTRY}/${ORG}/${BASE_IMAGE}:prod"
            SERVER_TAGS="${SERVER_TAGS},${REGISTRY}/${ORG}/${SERVER_IMAGE}:prod"
            CLIENT_TAGS="${CLIENT_TAGS},${REGISTRY}/${ORG}/${CLIENT_IMAGE}:prod"
            API_TAGS="${API_TAGS},${REGISTRY}/${ORG}/${API_IMAGE}:prod"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            BASE_TAGS="${BASE_TAGS},${REGISTRY}/${ORG}/${BASE_IMAGE}:stag"
            SERVER_TAGS="${SERVER_TAGS},${REGISTRY}/${ORG}/${SERVER_IMAGE}:stag"
            CLIENT_TAGS="${CLIENT_TAGS},${REGISTRY}/${ORG}/${CLIENT_IMAGE}:stag"
            API_TAGS="${API_TAGS},${REGISTRY}/${ORG}/${API_IMAGE}:stag"
          fi

          echo "base_tags=${BASE_TAGS}"   >> $GITHUB_OUTPUT
          echo "server_tags=${SERVER_TAGS}" >> $GITHUB_OUTPUT
          echo "client_tags=${CLIENT_TAGS}" >> $GITHUB_OUTPUT
          echo "api_tags=${API_TAGS}" >> $GITHUB_OUTPUT
          echo "Generated tags:"
          echo "Base:   ${BASE_TAGS}"
          echo "Server: ${SERVER_TAGS}"
          echo "Client: ${CLIENT_TAGS}"
          echo "API:    ${API_TAGS}"

      - name: Log in to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login $REGISTRY -u ${{ github.actor }} --password-stdin

      ###########################################
      # 1️⃣ Build Base Image
      ###########################################
      - name: Build Base Image
        run: |
          docker build ${BUILD_ARGS} \
            -f fl_services/fl-base/Dockerfile \
            -t $REGISTRY/$ORG/$BASE_IMAGE:${{ github.sha }} .

          # Tag environment-specific
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker tag $REGISTRY/$ORG/$BASE_IMAGE:${{ github.sha }} $REGISTRY/$ORG/$BASE_IMAGE:prod
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            docker tag $REGISTRY/$ORG/$BASE_IMAGE:${{ github.sha }} $REGISTRY/$ORG/$BASE_IMAGE:stag
          fi

          echo "✅ Built base image."

      - name: Push Base Image
        run: |
          docker push $REGISTRY/$ORG/$BASE_IMAGE:${{ github.sha }}
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker push $REGISTRY/$ORG/$BASE_IMAGE:prod
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            docker push $REGISTRY/$ORG/$BASE_IMAGE:stag
          fi
          echo "✅ Pushed base image."

      ###########################################
      # 2️⃣ Build and Push FL Server
      ###########################################
      - name: Build FL Server Image
        run: |
          docker build ${BUILD_ARGS} \
            -f fl_services/fl-server/Dockerfile \
            --build-arg BASE_REF=$REGISTRY/$ORG/$BASE_IMAGE:${{ github.sha }} \
            -t $REGISTRY/$ORG/$SERVER_IMAGE:${{ github.sha }} fl_services/fl-server

          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker tag $REGISTRY/$ORG/$SERVER_IMAGE:${{ github.sha }} $REGISTRY/$ORG/$SERVER_IMAGE:prod
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            docker tag $REGISTRY/$ORG/$SERVER_IMAGE:${{ github.sha }} $REGISTRY/$ORG/$SERVER_IMAGE:stag
          fi

          echo "✅ Built FL Server."

      - name: Push FL Server Image
        run: |
          docker push $REGISTRY/$ORG/$SERVER_IMAGE:${{ github.sha }}
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker push $REGISTRY/$ORG/$SERVER_IMAGE:prod
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            docker push $REGISTRY/$ORG/$SERVER_IMAGE:stag
          fi
          echo "✅ Pushed FL Server."

      ###########################################
      # 3️⃣ Build and Push FL Client
      ###########################################
      - name: Build FL Client Image
        run: |
          docker build ${BUILD_ARGS} \
            -f fl_services/fl-client/Dockerfile \
            --build-arg BASE_REF=$REGISTRY/$ORG/$BASE_IMAGE:${{ github.sha }} \
            -t $REGISTRY/$ORG/$CLIENT_IMAGE:${{ github.sha }} fl_services/fl-client

          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker tag $REGISTRY/$ORG/$CLIENT_IMAGE:${{ github.sha }} $REGISTRY/$ORG/$CLIENT_IMAGE:prod
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            docker tag $REGISTRY/$ORG/$CLIENT_IMAGE:${{ github.sha }} $REGISTRY/$ORG/$CLIENT_IMAGE:stag
          fi

          echo "✅ Built FL Client."

      - name: Push FL Client Image
        run: |
          docker push $REGISTRY/$ORG/$CLIENT_IMAGE:${{ github.sha }}
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker push $REGISTRY/$ORG/$CLIENT_IMAGE:prod
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            docker push $REGISTRY/$ORG/$CLIENT_IMAGE:stag
          fi
          echo "✅ Pushed FL Client."

      ###########################################
      # 4️⃣ Build and Push FL API
      ###########################################
      - name: Build FL API Image
        run: |
          docker build ${BUILD_ARGS} \
            -f fl_services/fl-api-base/Dockerfile \
            -t $REGISTRY/$ORG/$API_IMAGE:${{ github.sha }} fl_services/fl-api-base

          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker tag $REGISTRY/$ORG/$API_IMAGE:${{ github.sha }} $REGISTRY/$ORG/$API_IMAGE:prod
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            docker tag $REGISTRY/$ORG/$API_IMAGE:${{ github.sha }} $REGISTRY/$ORG/$API_IMAGE:stag
          fi

          echo "✅ Built FL API."

      - name: Push FL API Image
        run: |
          docker push $REGISTRY/$ORG/$API_IMAGE:${{ github.sha }}
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            docker push $REGISTRY/$ORG/$API_IMAGE:prod
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            docker push $REGISTRY/$ORG/$API_IMAGE:stag
          fi
          echo "✅ Pushed FL API."
