# # Copyright (c) 2026 Guy's and St Thomas' NHS Foundation Trust & King's College London
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Release notes preview on PR to main

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0 # required to resolve previous release tag

      - name: Extract version and previous tag
        id: meta
        run: |
          VERSION=$(grep -m1 '^version' pyproject.toml | sed 's/.*= *"\(.*\)"/\1/')
          PREV_TAG=$(git tag --list 'v*.*.*' | sort -V | tail -n1)

          echo "version=${VERSION}"           >> "$GITHUB_OUTPUT"
          echo "tag=v${VERSION}"              >> "$GITHUB_OUTPUT"
          echo "prev_tag=${PREV_TAG}"         >> "$GITHUB_OUTPUT"
          echo "head_sha=${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"

      - name: Post or update release notes preview comment
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.meta.outputs.version }}
          TAG: ${{ steps.meta.outputs.tag }}
          PREV_TAG: ${{ steps.meta.outputs.prev_tag }}
          HEAD_SHA: ${{ steps.meta.outputs.head_sha }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs   = require('fs');
            const path = require('path');

            const version = process.env.VERSION;
            const tag     = process.env.TAG;
            const prevTag = process.env.PREV_TAG || '';
            const headSha = process.env.HEAD_SHA;

            // ── Build header from template ──────────────────────────────────
            const templatePath = path.join(process.env.GITHUB_WORKSPACE, '.github', 'RELEASE_NOTES_TEMPLATE.md');
            let header = fs.readFileSync(templatePath, 'utf8');

            // Strip the license comment block before rendering
            header = header.replace(/<!--[\s\S]*?-->\n?/, '').trim();

            // Substitute placeholders
            header = header
              .replace(/\{\{VERSION\}\}/g, version)
              .replace(/\{\{TAG\}\}/g,     tag)
              .replace(/\{\{PREV_TAG\}\}/g, prevTag || 'initial release');

            // ── Generate changelog via GitHub API ───────────────────────────
            let generatedNotes = '';
            try {
              const params = {
                owner:             context.repo.owner,
                repo:              context.repo.repo,
                tag_name:          tag,
                target_commitish:  headSha,
              };
              if (prevTag) {
                params.previous_tag_name = prevTag;
              }
              const resp = await github.rest.repos.generateReleaseNotes(params);
              generatedNotes = resp.data.body;
            } catch (err) {
              console.log(`generateReleaseNotes API error: ${err.message}`);
              generatedNotes = '_Could not generate changelog preview at this time._';
            }

            // ── Compose the full comment body ───────────────────────────────
            const marker  = '<!-- release-notes-preview -->';
            const heading = `## :clipboard: Release Notes Preview — flip ${tag}`;
            const footer  = [
              '---',
              `> **Version:** \`${tag}\``,
              prevTag
                ? `> **Comparing:** [\`${prevTag}...${tag}\`](https://github.com/${context.repo.owner}/${context.repo.repo}/compare/${prevTag}...${tag})`
                : `> **First release** — no previous tag found.`,
              '',
              '_This preview is automatically generated and updated with each new commit pushed to this PR._',
            ].join('\n');

            const body = [marker, heading, '', header, '', generatedNotes, '', footer].join('\n');

            // ── Find an existing preview comment and update or create ────────
            const { data: comments } = await github.rest.issues.listComments({
              owner:        context.repo.owner,
              repo:         context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });

            const existing = comments.find(c => c.body && c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner:      context.repo.owner,
                repo:       context.repo.repo,
                comment_id: existing.id,
                body,
              });
              console.log(`Updated existing preview comment (id: ${existing.id})`);
            } else {
              await github.rest.issues.createComment({
                owner:        context.repo.owner,
                repo:         context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body,
              });
              console.log('Created new preview comment.');
            }
