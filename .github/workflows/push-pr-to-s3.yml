# # Copyright (c) Guy's and St Thomas' NHS Foundation Trust & King's College London
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Push src folder to S3 on PRs

on:
  pull_request:
    types: [synchronize, reopened]
    paths:
      - "src/**" # only trigger if files inside src/ changed

permissions:
  id-token: write # required for OIDC
  contents: read

concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  sync-pr:
    name: Sync src/ to PR-scoped S3 path (branch head)
    runs-on: ubuntu-latest
    # Skip PRs from forks to avoid missing creds (no secrets/OIDC by default).
    if: ${{ github.event.pull_request.head.repo.fork == false }}
    environment: flip

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4.2.1
        with:
          role-to-assume: ${{ vars.AWS_ROLE_TO_ASSUME }}
          role-session-name: ${{ vars.AWS_ROLE_SESSION_NAME }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Derive PR metadata (use branch head SHA)
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          SHORT_SHA="${HEAD_SHA::7}"   # first 7 chars of branch head
          echo "HEAD_SHA=$HEAD_SHA" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          # Write the full branch-head SHA into the file
          echo "$HEAD_SHA" > "commit_${SHORT_SHA}.txt"

      - name: Sync src folder and commit SHA to PR S3 path
        env:
          S3_FOLDER_URI: s3://${{ vars.AWS_DEV_S3_BUCKET_NAME }}/base-application-dev/pull-requests/${{ env.PR_NUMBER }}
        run: |
          aws s3 rm "${S3_FOLDER_URI}/" --recursive --exclude "*" --include "commit_*.txt" --only-show-errors
          aws s3 sync src/ "${S3_FOLDER_URI}/src/" --delete
          aws s3 cp "commit_${SHORT_SHA}.txt" "${S3_FOLDER_URI}/commit_${SHORT_SHA}.txt"
