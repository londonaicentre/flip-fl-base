# # Copyright (c) 2026 Guy's and St Thomas' NHS Foundation Trust & King's College London
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: Release flip to PyPI on merge to main

on:
  push:
    branches:
      - main

permissions:
  contents: write # required to create git tags and GitHub releases
  id-token: write # required for OIDC

jobs:
  release:
    runs-on: ubuntu-latest
    environment: flip

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # full history + all tags required for tag existence check

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep -m1 '^version' pyproject.toml | sed 's/.*= *"\(.*\)"/\1/')
          INIT_VERSION=$(grep -m1 '__version__' flip/__init__.py | sed 's/.*= *"\(.*\)"/\1/')

          if [[ "$VERSION" != "$INIT_VERSION" ]]; then
            echo "ERROR: Version mismatch — pyproject.toml has '${VERSION}' but flip/__init__.py has '${INIT_VERSION}'."
            exit 1
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${VERSION}"    >> "$GITHUB_OUTPUT"
          echo "Detected version: ${VERSION}"

      - name: Check if tag already exists
        id: check_tag
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists — this version has already been released. Skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "Tag ${TAG} not found — proceeding with release."
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        if: steps.check_tag.outputs.skip == 'false'
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        if: steps.check_tag.outputs.skip == 'false'
        run: pip install uv

      - name: Install dependencies
        if: steps.check_tag.outputs.skip == 'false'
        run: uv sync

      - name: Run linter
        if: steps.check_tag.outputs.skip == 'false'
        run: uv run ruff check .

      - name: Run unit tests
        if: steps.check_tag.outputs.skip == 'false'
        run: uv run pytest -s -vv

      - name: Build package
        if: steps.check_tag.outputs.skip == 'false'
        run: uv build

      - name: Publish to PyPI
        if: steps.check_tag.outputs.skip == 'false'
        run: |
          uv publish \
            --publish-url https://upload.pypi.org/legacy/ \
            --check-url   https://pypi.org/simple/ \
            --token       "${{ secrets.PYPI_TOKEN }}"

      - name: Create and push git tag
        if: steps.check_tag.outputs.skip == 'false'
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      - name: Create GitHub Release
        if: steps.check_tag.outputs.skip == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "flip ${{ steps.version.outputs.tag }}" \
            --generate-notes \
            dist/*
